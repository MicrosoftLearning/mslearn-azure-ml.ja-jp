---
lab:
  title: Azure Machine Learning でコマンド ジョブとしてトレーニング スクリプトを実行する
---

# Azure Machine Learning でコマンド ジョブとしてトレーニング スクリプトを実行する

ノートブックは、実験や開発に最適です。 機械学習モデルを開発し、運用の準備ができたら、スクリプトを使用してトレーニングする必要があります。 スクリプトはコマンド ジョブとして実行できます。

この演習では、スクリプトをテストしてから、コマンド ジョブとして実行します。

## 開始する前に

管理レベルのアクセス権を持つ [Azure サブスクリプション](https://azure.microsoft.com/free?azure-portal=true)が必要です。

## Azure Machine Learning ワークスペースをプロビジョニングする

Azure Machine Learning ''ワークスペース'' では、モデルのトレーニングと管理に必要なすべてのリソースと資産を管理するための中心的な場所が提供されます。** Azure Machine Learning ワークスペースは、スタジオ、Python SDK、Azure CLI を使用して操作できます。

Azure CLI を使用してワークスペースと必要なコンピューティングをプロビジョニングし、Python SDK を使用してコマンド ジョブを実行します。

### ワークスペースとコンピューティング リソースを作成する

Azure Machine Learning ワークスペース、コンピューティング インスタンス、コンピューティング クラスターを作成するには、Azure CLI を使用します。 実行するために必要なすべてのコマンドがシェル スクリプトにグループ化されます。

1. ブラウザーで、Azure portal (`https://portal.azure.com/`) を開き、Microsoft アカウントでサインインします。
1. ページ上部の検索ボックスの右側にある \[>_] (*Cloud Shell*) ボタンを選びます。 これにより、ポータルの下部に Cloud Shell ペインが開きます。
1. メッセージが表示されたら、 **[Bash]** を選択します。 Cloud Shell を初めて開いたときに、使用するシェルの種類 (*Bash* または *PowerShell*) を選択するように求められます。
1. 正しいサブスクリプションが指定されていることと、**[ストレージ アカウントは不要]** が選択されていることを確認します。 **適用**を選択します。
1. ターミナルで、次のコマンドを入力して、このリポジトリをクローンします。

    ```azurecli
    rm -r azure-ml-labs -f
    git clone https://github.com/MicrosoftLearning/mslearn-azure-ml.git azure-ml-labs
    ```

    > コピーしたコードを Cloud Shell に貼り付けるには、`SHIFT + INSERT` を使用します。

1. リポジトリがクローンされたら、次のコマンドを入力してこのラボ用のフォルダーに移動し、そこに含まれている **setup.sh** スクリプトを実行します。
    
    ```azurecli
    cd azure-ml-labs/Labs/08
    ./setup.sh
    ```

    > 拡張機能がインストールされていないことを示す (エラー) メッセージは無視します。

1. スクリプトが完了するまで待ちます。通常、約 5 分から 10 分かかります。

    <details>
    <summary><b>トラブルシューティングのヒント</b>: ワークスペース作成エラー</summary><br>
    <p>CLI を使用してセットアップ スクリプトを実行するときにエラーが発生した場合は、リソースを手動でプロビジョニングする必要があります。</p>
    <ol>
        <li>Azure portal のホーム ページで、<b>[+ リソースの作成]</b> を選択します。</li>
        <li><i>machine learning</i> を検索し、<b>Azure Machine Learning</b> を選択します。 <b>［作成］</b> を選択します</li>
        <li>次の設定を使用して新しい Azure Machine Learning リソースを作成します。 <ul>
                <li><b>[サブスクリプション]</b>:"<i>ご自身の Azure サブスクリプション</i>"</li>
                <li><b>リソース グループ</b>: rg-dp100-labs</li>
                <li><b>ワークスペース名</b>: mlw-dp100-labs</li>
                <li><b>[リージョン]</b>: "<i>最も近い地理的リージョンを選択します</i>"</li>
                <li><b>[ストレージ アカウント]</b>: "<i>ワークスペース用に作成される既定の新しいストレージ アカウントに注目します</i>"</li>
                <li><b>[キー コンテナー]</b>: <i>ワークスペース用に作成される既定の新しいキー コンテナーです</i></li>
                <li><b>[Application Insights]</b>: <i>ワークスペース用に作成される既定の新しい Application Insights リソースです</i></li>
                <li><b>[コンテナー レジストリ]</b>: なし (<i>コンテナーにモデルを初めてデプロイするときに、自動的に作成されます</i>)</li>
            </ul>
        <li><b>[確認および作成]</b> を選択し、ワークスペースとそれに関連付けられているリソースが作成されるまで待ちます。通常、これには約 5 分かかります。</li>
        <li><b>[リソースに移動]</b> を選択して、リソースの <b>[概要]</b> ページで <b>[スタジオの起動]</b> を選択します。 ブラウザーで別のタブが開き、Azure Machine Learning スタジオが開きます。</li>
        <li>スタジオに表示されるすべてのポップアップを閉じます。</li>
        <li>Azure Machine Learning スタジオ内で、<b>[コンピューティング]</b> ページに移動し、<b>[コンピューティング インスタンス]</b> タブの <b>[+ 新規]</b> を選択します。</li>
        <li>コンピューティング インスタンスに一意の名前を付けたあと、仮想マシンのサイズとして <b>Standard_DS11_v2</b> を選択します。</li>
        <li><b>[確認および作成]</b> を選択し、次に <b>[作成]</b> を選択します。</li>
        <li>次に、<b>[コンピューティング クラスター]</b> タブを選択し、<b>[+ 新規]</b> を選択します。</li>
        <li>ワークスペースを作成したリージョンと同じリージョンを選択し、仮想マシンのサイズとして <b>Standard_DS11_v2</b> を選択します。 <b>[次へ]</b> を選択します</li>
        <li>クラスターに一意の名前を付け、<b>[作成]</b> を選択します。</li>
    </ol>
    </details>

## ラボの資料をクローンする

ワークスペースと必要なコンピューティング リソースを作成したら、Azure Machine Learning スタジオを開き、ラボの資料をワークスペースに複製できます。

1. Azure portal で、**mlw-dp100-...** という名前の Azure Machine Learning ワークスペースに移動します。
1. Azure Machine Learning ワークスペースを選択し、その **[概要]** ページで **[スタジオの起動]** を選択します。 ブラウザーで別のタブが開き、Azure Machine Learning スタジオが開きます。
1. スタジオに表示されるすべてのポップアップを閉じます。
1. Azure Machine Learning スタジオ内で、 **[コンピューティング]** ページに移動し、前のセクションで作成したコンピューティング インスタンスとクラスターが存在することを確認します。 コンピューティング インスタンスが実行中である必要があります。クラスターはアイドル状態で、0 個のノードが実行中であるはずです。
1. **[コンピューティング インスタンス]** タブで、コンピューティング インスタンスを見つけて、 **[ターミナル]** アプリケーションを選択します。
1. ターミナルで、次のコマンドを実行して、コンピューティング インスタンスに Python SDK をインストールします。

    ```
    pip uninstall azure-ai-ml
    pip install azure-ai-ml
    ```

    > パッケージが見つからず、アンインストールできなかったことを示す (エラー) メッセージは無視します。

1. 次のコマンドを実行して、ノートブック、データ、その他のファイルを含む Git リポジトリをワークスペースにクローンします。

    ```
    git clone https://github.com/MicrosoftLearning/mslearn-azure-ml.git azure-ml-labs
    ```

1. コマンドが完了したら、 **[ファイル]** ペインで **[&#8635;]** をクリックしてビューを更新し、新しい **Users/<自分のユーザー名>/azure-ml-labs** フォルダーが作成されていることを確認します。**

## ノートブックをスクリプトに変換する

コンピューティング インスタンスにアタッチされたノートブックを使用すると、記述したコードをすぐに実行し、その出力を確認できるため、実験と開発に最適です。 開発から運用環境に移行するには、スクリプトを使用する必要があります。 最初の手順として、Azure Machine Learning スタジオを使用してノートブックをスクリプトに変換できます。

1. **Labs/08/src/Train classification model.ipynb** ノートブックを開きます。

    > **[認証]** を選択し、認証を求める通知が表示されたら、必要な手順に従います。

1. ノートブックで **Python 3.10 - AzureML** カーネルが使用されていることを確認します。
1. すべてのセルを実行してコードを調べ、モデルをトレーニングします。
1. ノートブックの上部にある [&#9776;] アイコンを選択して、**ノートブック メニュー**を表示します。
1. **[名前をつけてエクスポート]** を展開し、 **[Python (.py)]** を選択してノートブックを Python スクリプトに変換します。
1. 新しいファイルに `train-classification-model` という名前を付けます。
1. 新しいファイルが作成されると、スクリプトが自動的に開かれます。 ファイルを調べて、ノートブックと同じコードが含まれていることに注意してください。
1. ノートブックの上部にある [&#9655;&#9655;] アイコンを選択して、**ターミナルでスクリプトを保存して実行します**。
1. スクリプトはコマンド **python train-classification-model.py** によって開始され、コマンドの下に出力が表示されます。

   > **注:** スクリプトが libstdc++6 の ImportError を返す場合は、スクリプトを再度実行する前にターミナルで次のコマンドを実行します。
   > ```bash
   > sudo add-apt-repository ppa:ubuntu-toolchain-r/test
   > sudo apt-get update
   > sudo apt-get upgrade libstdc++6
   > ```

## ターミナルでスクリプトをテストする

ノートブックをスクリプトに変換後、さらに手を加えることができます。 スクリプトを使用する場合のベスト プラクティスの 1 つは、関数を使用することです。 スクリプトが関数で構成されていると、コードの単体テストが簡単になります。 関数を使用する場合、スクリプトはコード ブロックで構成され、各ブロックが特定のタスクを実行します。

1. **Labs/08/src/train-model-parameters.py** スクリプトを開き、その内容を調べます。
    他の 4 つの関数を含む main 関数があることに注意してください。

    - データの読み取り
    - データを分割する
    - モデルのトレーニング
    - モデルの評価

    main 関数の後に、各関数が定義されます。 各関数で必要な入力と出力を定義する方法に注意してください。

1. ノートブックの上部にある [&#9655;&#9655;] アイコンを選択して、**ターミナルでスクリプトを保存して実行します**。 "**データを読み込んでいます...** " の後、ファイル パスが無効なためデータを取得できなかったことを示すエラーが表示されます。

    スクリプトを使用すると、コードをパラメーター化して、入力データまたはパラメーターを簡単に変更できます。 この例の場合、スクリプトに、指定しなかったデータ パスの入力パラメーターが必要です。 **parse_args()** 関数のスクリプトの最後に、定義された必要なパラメーターがあります。

    2 つの入力パラメーターが定義されています。
    - **--training_data** には文字列が必要です。
    - **--reg_rate** には数値が必要ですが、既定値は 0.01 です。

    スクリプトを正常に実行するには、トレーニング データ パラメーターの値を指定する必要があります。 そのためには、トレーニング スクリプトと同じフォルダーに格納されている **diabetes.csv** ファイルを参照します。

1. ターミナルで次のコマンドを実行します。

    ```
    cd azure-ml-labs/Labs/08/src/
    python train-model-parameters.py --training_data diabetes.csv
    ```

スクリプトは正常に実行され、その結果、トレーニングされたモデルの精度と AUC が出力に表示されます。

ターミナルでスクリプトをテストすることは、スクリプトが期待どおりに動作するかどうかを確認するのに最適です。 コードに問題がある場合は、ターミナルにエラーが表示されます。

**必要に応じて**、コードを編集してエラーを強制的に発生させ、ターミナルでコマンドをもう一度実行してスクリプトを実行します。 たとえば、**import pandas as pd** という行を削除し、入力パラメーターを含むスクリプトを保存して実行し、エラー メッセージを確認します。

## スクリプトをコマンド ジョブとして実行する

スクリプトが機能することがわかっている場合は、コマンド ジョブとして実行できます。 スクリプトをコマンド ジョブとして実行することで、スクリプトのすべての入力と出力を追跡できます。

1. **Labs/08/Run script as command job.ipynb** ノートブックを開きます。
1. ノートブック内のすべてのセルを実行します。
1. Azure Machine Learning スタジオで、 **[ジョブ]** ページに移動します。
1. **diabetes-train-script** ジョブに移動して、実行したコマンド ジョブの概要を確認します。
1. **[コード]** タブに移動します。コマンド ジョブの **code** パラメーターの値であった **src** フォルダーのすべての内容が、ここにコピーされています。 コマンド ジョブによって実行されたトレーニング スクリプトを確認できます。
1. **[出力 + ログ]** タブに移動します。
1. **std_log.txt** ファイルを開き、その内容を調べます。 このファイルの内容は、コマンドの出力です。 ターミナルでスクリプトをテストしたときに、そこに同じ出力が表示されていたことを思い出してください。 スクリプトの問題が原因でジョブが失敗した場合は、ここにエラー メッセージが表示されます。

**必要に応じて**、コードを編集して強制的にエラーを発生させ、ノートブックを使用してコマンド ジョブをもう一度開始します。 たとえば、スクリプトから **import pandas as pd** という行を削除し、スクリプトを保存します。 または、コマンド ジョブ構成を編集して、スクリプトではなくジョブ構成自体に問題があるときのエラー メッセージを調べることができます。

## Azure リソースを削除する

Azure Machine Learning を調べ終わったら、不要な Azure のコストを避けるために作成したリソースを削除する必要があります。

1. [Azure Machine Learning スタジオ] タブを閉じて、Azure portal に戻ります。
1. Azure portal の **[ホーム]** ページで、**[リソース グループ]** を選択します。
1. **[rg-dp100-...]** リソース グループを選択します。
1. リソース グループの **[概要]** ページの上部で、**[リソース グループの削除]** を選択します。
1. リソース グループ名を入力して、削除することを確認し、**[削除]** を選択します。
