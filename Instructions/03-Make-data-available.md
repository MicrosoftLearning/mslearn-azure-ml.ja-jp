---
lab:
  title: Azure Machine Learning でデータを使用できるようにする
---

# Azure Machine Learning でデータを使用できるようにする

ローカル ファイル システム上のデータを操作することはかなり一般的ですが、エンタープライズ環境では、複数のデータ サイエンティストと機械学習エンジニアがアクセスできる中央の場所にデータを格納する方が効果的です。

この演習では、Azure Machine Learning でのデータ アクセスを抽象化するために使用される主なオブジェクトである*データストア*と*データ資産*について学びます。

## 開始する前に

管理レベルのアクセス権を持つ [Azure サブスクリプション](https://azure.microsoft.com/free?azure-portal=true)が必要です。

## Azure Machine Learning ワークスペースをプロビジョニングする

Azure Machine Learning ''ワークスペース'' では、モデルのトレーニングと管理に必要なすべてのリソースと資産を管理するための中心的な場所が提供されます。** Azure Machine Learning ワークスペースは、スタジオ、Python SDK、Azure CLI を使用して操作できます。

Azure CLI を使用してワークスペースと必要なリソースをプロビジョニングする、シェル スクリプトを使用します。 次に、Azure Machine Learning スタジオのデザイナーを使用して、モデルのトレーニングと比較を行います。

### ワークスペースとコンピューティング リソースを作成する

Azure Machine Learning ワークスペースとコンピューティング リソースを作成するには、Azure CLI を使用します。 実行するために必要なすべてのコマンドがシェル スクリプトにグループ化されます。

1. ブラウザーで、Azure portal (`https://portal.azure.com/`) を開き、Microsoft アカウントでサインインします。
1. ページ上部の検索ボックスの右側にある \[>_] (*Cloud Shell*) ボタンを選びます。 これにより、ポータルの下部に Cloud Shell ペインが開きます。
1. メッセージが表示されたら、 **[Bash]** を選択します。 Cloud Shell を初めて開いたときに、使用するシェルの種類 (*Bash* または *PowerShell*) を選択するように求められます。
1. 正しいサブスクリプションが指定されていることと、**[ストレージ アカウントは不要]** が選択されていることを確認します。 **適用**を選択します。
1. ターミナルで次のコマンドを入力して、このリポジトリをクローンします。

    ```azurecli
    rm -r azure-ml-labs -f
    git clone https://github.com/MicrosoftLearning/mslearn-azure-ml.git azure-ml-labs
    ```

    > コピーしたコードを Cloud Shell に貼り付けるには、`SHIFT + INSERT` を使用します。

1. リポジトリがクローンされたら、次のコマンドを入力してこのラボ用のフォルダーに移動し、そこに含まれている **setup.ps1** スクリプトを実行します。

    ```azurecli
    cd azure-ml-labs/Labs/03
    ./setup.sh
    ```

    > 拡張機能がインストールされていないことを示す (エラー) メッセージは無視します。

1. スクリプトが完了するまで待ちます。通常、約 5 分から 10 分かかります。

    <details>
    <summary><b>トラブルシューティングのヒント</b>: ワークスペース作成エラー</summary><br>
    <p>CLI を使用してセットアップ スクリプトを実行するときにエラーが発生した場合は、リソースを手動でプロビジョニングする必要があります。</p>
    <ol>
        <li>Azure portal のホーム ページで、<b>[+ リソースの作成]</b> を選択します。</li>
        <li><i>machine learning</i> を検索し、<b>Azure Machine Learning</b> を選択します。 <b>［作成］</b> を選択します</li>
        <li>次の設定を使用して新しい Azure Machine Learning リソースを作成します。 <ul>
                <li><b>[サブスクリプション]</b>:"<i>ご自身の Azure サブスクリプション</i>"</li>
                <li><b>リソース グループ</b>: rg-dp100-labs</li>
                <li><b>ワークスペース名</b>: mlw-dp100-labs</li>
                <li><b>[リージョン]</b>: "<i>最も近い地理的リージョンを選択します</i>"</li>
                <li><b>[ストレージ アカウント]</b>: "<i>ワークスペース用に作成される既定の新しいストレージ アカウントに注目します</i>"</li>
                <li><b>[キー コンテナー]</b>: <i>ワークスペース用に作成される既定の新しいキー コンテナーです</i></li>
                <li><b>[Application Insights]</b>: <i>ワークスペース用に作成される既定の新しい Application Insights リソースです</i></li>
                <li><b>[コンテナー レジストリ]</b>: なし (<i>コンテナーにモデルを初めてデプロイするときに、自動的に作成されます</i>)</li>
            </ul>
        <li><b>[確認および作成]</b> を選択し、ワークスペースとそれに関連付けられているリソースが作成されるまで待ちます。通常、これには約 5 分かかります。</li>
        <li><b>[リソースに移動]</b> を選択して、リソースの <b>[概要]</b> ページで <b>[スタジオの起動]</b> を選択します。 ブラウザーで別のタブが開き、Azure Machine Learning スタジオが開きます。</li>
        <li>スタジオに表示されるすべてのポップアップを閉じます。</li>
        <li>Azure Machine Learning スタジオ内で、<b>[コンピューティング]</b> ページに移動し、<b>[コンピューティング インスタンス]</b> タブの <b>[+ 新規]</b> を選択します。</li>
        <li>コンピューティング インスタンスに一意の名前を付けたあと、仮想マシンのサイズとして <b>Standard_DS11_v2</b> を選択します。</li>
        <li><b>[確認および作成]</b> を選択し、次に <b>[作成]</b> を選択します。</li>
        <li>次に、<b>[コンピューティング クラスター]</b> タブを選択し、<b>[+ 新規]</b> を選択します。</li>
        <li>ワークスペースを作成したリージョンと同じリージョンを選択し、仮想マシンのサイズとして <b>Standard_DS11_v2</b> を選択します。 <b>[次へ]</b> を選択します</li>
        <li>クラスターに一意の名前を付け、<b>[作成]</b> を選択します。</li>
    </ol>
    </details>

## 既定のデータストアを探索する

Azure Machine Learning ワークスペースを作成すると、ストレージ アカウントが自動的に作成され、ワークスペースに接続されます。 ストレージ アカウントの接続方法について説明します。

1. Azure portal で、**rg-dp100-...** という名前の新しいリソース グループに移動します。
1. リソース グループ内のストレージ アカウントを選択します。 多くの場合、名前はワークスペースに指定した名前 (ハイフンなし) で始まります。
1. ストレージ アカウントの **[概要]** ページを確認します。 [概要] ペインと左側のメニューに表示されるように、ストレージ アカウントには **[データ ストレージ]** のいくつかのオプションがあることに注意してください。
1. **[コンテナー]** を選択して、ストレージ アカウントの BLOB ストレージ部分を探索します。
1. **azureml-blobstore-...** コンテナーに注目します。 データ資産の既定のデータストアでは、このコンテナーを使用してデータが保存されます。
1. 画面の上部にある &#43; **[コンテナー]** ボタンを使用して、新しいコンテナーを作成し、`training-data` という名前を付けます。
1. 左側のメニューから **[ファイル共有]** を選択して、ストレージ アカウントのファイル共有の部分を探索します。
1. **code-...** ファイル共有に注目します。 ワークスペース内のすべてのノートブックがここに保存されます。 ラボの資料を複製した後、このファイル共有のファイルを **code-.../Users/<自分のユーザー名>/azure-ml-labs** フォルダー内に見つけることができます。**

## アクセス キーをコピーする

Azure Machine Learning ワークスペースにデータストアを作成するには、何らかの資格情報を入力する必要があります。 BLOB ストレージへのアクセス権をワークスペースに付与する簡単な方法は、アカウント キーを使用することです。

1. ストレージ アカウントで、左側のメニューから **[アクセス キー]** タブを選択します。
1. key1 と key2 の 2 つのキーが用意されていることに注意してください。 それぞれのキーの機能は同じです。 
1. **[key1]** の **[キー]** フィールドで **[表示]** を選択します。
1. **[キー]** フィールドの値をメモ帳にコピーします。 後でこの値をノートブックに貼り付ける必要があります。
1. ページの上部からストレージ アカウントの名前をコピーします。 名前は **mlwdp100storage..** で始まる必要があります。この値も後でノートブックに貼り付ける必要があります。

> **注**: 自動大文字化 (Word で実行される) を回避するために、アカウント キーと名前はメモ帳にコピーします。 キーは大文字と小文字が区別されます。

## ラボの資料をクローンする

Python SDK を使用してデータストアとデータ資産を作成するには、ラボの資料をワークスペースに複製する必要があります。

1. Azure portal で、**mlw-dp100-labs** という名前の Azure Machine Learning ワークスペースに移動します。
1. Azure Machine Learning ワークスペースを選択し、その **[概要]** ページで **[スタジオの起動]** を選択します。 ブラウザーで別のタブが開き、Azure Machine Learning スタジオが開きます。
1. スタジオに表示されるすべてのポップアップを閉じます。
1. Azure Machine Learning スタジオ内で、 **[コンピューティング]** ページに移動し、前のセクションで作成したコンピューティング インスタンスとクラスターが存在することを確認します。 コンピューティング インスタンスが実行中である必要があります。クラスターはアイドル状態で、0 個のノードが実行中であるはずです。
1. **[コンピューティング インスタンス]** タブで、コンピューティング インスタンスを見つけて、 **[ターミナル]** アプリケーションを選択します。
1. ターミナルで、次のコマンドを実行して、コンピューティング インスタンスに Python SDK をインストールします。

    ```azurecli
    pip uninstall azure-ai-ml
    pip install azure-ai-ml
    pip install mltable
    ```

    > パッケージがインストールされなかったことを示す (エラー) メッセージは無視します。

1. 次のコマンドを実行して、ノートブック、データ、その他のファイルを含む Git リポジトリをワークスペースにクローンします。

    ```azurecli
    git clone https://github.com/MicrosoftLearning/mslearn-azure-ml.git azure-ml-labs
    ```

1. コマンドが完了したら、 **[ファイル]** ペインで **[&#8635;]** をクリックしてビューを更新し、新しい **Users/<自分のユーザー名>/azure-ml-labs** フォルダーが作成されていることを確認します。**

**必要に応じて**、別のブラウザー タブで [Microsoft Azure portal](https://portal.azure.com?azure-portal=true) に戻ります。 ストレージ アカウントでファイル共有 **code-...** をもう一度探し、新しく作成された **azure-ml-labs** フォルダーで、複製されたラボの資料を見つけます。

## データストアとデータ資産を作成する

Python SDK を使用してデータストアとデータ資産を作成するコードが、ノートブックで提供されています。

1. **Labs/03/Work with data.ipynb** ノートブックを開きます。

    > **[認証]** を選択し、認証を求める通知が表示されたら、必要な手順に従います。

1. ノートブックで **Python 3.8 - AzureML** カーネルが使用されていることを確認します。
1. ノートブック内のすべてのセルを実行します。

## 省略可能: データ資産を調べる

**必要に応じて**、関連付けられているストレージ アカウントにデータ資産を保存する方法を調べることができます。

1. Azure Machine Learning スタジオの **[データ]** タブに移動して、データ資産を探索します。
1. **diabetes-local** というデータ資産名を選択して、その詳細を確認します。 

    **diabetes-local** データ資産の **[データ ソース]** に、ファイルがどこにアップロードされたかが表示されます。 **LocalUpload/...** で始まるパスは、ストレージ アカウント コンテナー **azureml-blobstore-..** 内のパスを示しています。Azure portal でそのパスに移動することで、ファイルが存在することを確認できます。

## Azure リソースを削除する

Azure Machine Learning を調べ終わったら、不要な Azure のコストを避けるために作成したリソースを削除する必要があります。

1. [Azure Machine Learning スタジオ] タブを閉じて、Azure portal に戻ります。
1. Azure portal の **[ホーム]** ページで、**[リソース グループ]** を選択します。
1. **[rg-dp100-...]** リソース グループを選択します。
1. リソース グループの **[概要]** ページの上部で、**[リソース グループの削除]** を選択します。
1. リソース グループ名を入力して、削除することを確認し、**[削除]** を選択します。
