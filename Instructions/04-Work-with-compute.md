---
lab:
  title: Azure Machine Learning でコンピューティング リソースを使用する
---

# Azure Machine Learning でコンピューティング リソースを使用する

クラウドの主な利点の 1 つは、スケーラブルなオンデマンドのコンピューティング リソースを使用して、大規模なデータのコスト効率の高い処理を実現できることです。

この演習では、Azure Machine Learning でクラウド コンピューティングを使用して、実験と運用コードを大規模に実行する方法について学習します。

## 開始する前に

管理レベルのアクセス権を持つ [Azure サブスクリプション](https://azure.microsoft.com/free?azure-portal=true)が必要です。

## Azure Machine Learning ワークスペースをプロビジョニングする

Azure Machine Learning ''ワークスペース'' では、モデルのトレーニングと管理に必要なすべてのリソースと資産を管理するための中心的な場所が提供されます。** Azure Machine Learning ワークスペースは、スタジオ、Python SDK、Azure CLI を使用して操作できます。

Azure Machine Learning ワークスペースを作成するには、Azure CLI を使用します。 実行するために必要なすべてのコマンドがシェル スクリプトにグループ化されます。

1. ブラウザーで、Azure portal (`https://portal.azure.com/`) を開き、Microsoft アカウントでサインインします。
1. ページ上部の検索ボックスの右側にある \[>_] (*Cloud Shell*) ボタンを選びます。 これにより、ポータルの下部に Cloud Shell ペインが開きます。
1. メッセージが表示されたら、 **[Bash]** を選択します。 Cloud Shell を初めて開いたときに、使用するシェルの種類 (*Bash* または *PowerShell*) を選択するように求められます。 
1. Cloud Shell のストレージを作成するように求められた場合は、正しいサブスクリプションが指定されていることを確認して、 **[ストレージの作成]** を選択します。 ストレージが作成されるまで待ちます。
1. 以前のバージョンとの競合を回避するには、ターミナルでこのコマンドを実行して、ML CLI 拡張機能 (バージョン 1 と 2 の両方) を削除します。

    ```azurecli
    az extension remove -n azure-cli-ml
    az extension remove -n ml
    ```

    > コピーしたコードを Cloud Shell に貼り付けるには、`SHIFT + INSERT` を使用します。 

    > 拡張機能がインストールされていないことを示す (エラー) メッセージは無視します。 

1. 次のコマンドを使用して、Azure Machine Learning (v2) 拡張機能をインストールします。
    
    ```azurecli
    az extension add -n ml -y
    ```

1. リソース グループを作成する。 近くの場所を選択します。

    ```azurecli
    az group create --name "rg-dp100-labs" --location "eastus"
    ```

1. ワークスペースを作成します。

    ```azurecli
    az ml workspace create --name "mlw-dp100-labs" -g "rg-dp100-labs"
    ```

1. コマンドが完了するまで待ちます。通常、約 5 分から 10 分かかります。 

## コンピューティング セットアップ スクリプトを作成する

Azure Machine Learning ワークスペース内でノートブックを実行するには、コンピューティング インスタンスが必要です。 セットアップ スクリプトを使用して、作成時にコンピューティング インスタンスを構成できます。

1. Azure portal で、**mlw-dp100-labs** という名前の Azure Machine Learning ワークスペースに移動します。
1. Azure Machine Learning ワークスペースを選択し、その **[概要]** ページで **[スタジオの起動]** を選択します。 ブラウザーで別のタブが開き、Azure Machine Learning スタジオが開きます。
1. スタジオに表示されるすべてのポップアップを閉じます。
1. Azure Machine Learning スタジオ内で、 **[ノートブック]** ページに移動します。
1. **[ファイル]** ペインで、**ファイルを追加する**ための &#10753; アイコンを選択します。 
1. **[Create new file](新しいファイルの作成)** を選択します。
1. ファイルの場所が **Users/* <自分のユーザー名>*** であることを確認します。
1. ファイルの種類を **[Bash (*.sh)]** に変更します。
1. ファイル名を `compute-setup.sh` に変更します。
1. 新しく作成した **compute-setup.sh** ファイルを開き、以下をその内容に貼り付けます。

    ```azurecli
    #!/bin/bash

    # clone repository
    git clone https://github.com/MicrosoftLearning/mslearn-azure-ml.git azure-ml-labs
    ```

1. **compute-setup.sh** ファイルを保存します。

## コンピューティング インスタンスを作成する

コンピューティング インスタンスを作成するために、スタジオ、Python SDK、または Azure CLI を使用できます。 スタジオを使用して、先ほど作成したセットアップ スクリプトでコンピューティング インスタンスを作成します。

1. 左側のメニューを使用して、 **[コンピューティング]** ページに移動します。
1. **[コンピューティング インスタンス]** タブで、 **[新規]** を選択します。
1. 次の設定を使用してコンピューティング インスタンスを構成します (まだ作成しないでください)。 
    - **[コンピューティング名]**: "*一意の名前を入力します*"
    - **仮想マシンの種類**: *CPU*
    - **仮想マシンのサイズ**: *Standard_DS11_v2*
1. **詳細設定** を選択します。
1. **[スケジュールの追加]** を選択し、毎日 **18 時**または**午後 6 時**にコンピューティング インスタンスを**停止する**ようにスケジュールを構成します。 
1. **[セットアップ スクリプトを使用したプロビジョニング]** の切り替えを選択します。 
1. 前に作成した **compute-setup.sh** スクリプトを選択します。
1. 他の詳細設定を確認しますが、選択**しないでください**。
    - **SSH アクセスの有効化**: "これを使って、SSH クライアントを使用した仮想マシンへの直接アクセスを有効にすることができます。"**
    - **仮想ネットワークの有効化**: "通常、これをエンタープライズ環境で使用してネットワーク セキュリティを強化します。"**
    - **他のユーザーへ割り当て**: "これを使用して、コンピューティング インスタンスを別のデータ サイエンティストに割り当てることができます。"**
1. コンピューティング インスタンスを**作成**し、それが起動し、その状態が **[実行中]** に変わるまで待ちます。
1. コンピューティング インスタンスが実行されている場合は、 **[ノートブック]** ページに移動します。 **[ファイル]** ペインで、 **[&#8635;]** をクリックしてビューを更新し、新しい **Users/<自分のユーザー名>/mslearn-dp100** フォルダーが作成されていることを確認します。** 

## コンピューティング インスタンスを構成する

コンピューティング インスタンスを作成したら、そこでノートブックを実行できます。 必要なコードを実行するには、特定のパッケージをインストールする必要がある場合があります。 セットアップ スクリプトにパッケージを含めたり、ターミナルを使用してそれらをインストールしたりできます。

1. **[コンピューティング インスタンス]** タブで、コンピューティング インスタンスを見つけて、 **[ターミナル]** アプリケーションを選択します。
1. ターミナルで、次のコマンドを実行して、コンピューティング インスタンスに Python SDK をインストールします。

    ```
    pip uninstall azure-ai-ml
    pip install azure-ai-ml
    ```

    > パッケージがインストールされなかったことを示す (エラー) メッセージは無視します。

1. パッケージがインストールされたら、タブを閉じてターミナルを終了できます。 

## コンピューティング クラスターを作成する

ノートブックは、実験中の開発や反復作業に最適です。 実験するときは、コンピューティング インスタンスでノートブックを実行して、コードをすばやくテストして確認する必要があります。 運用環境に移行するときは、コンピューティング クラスターでスクリプトを実行する必要があります。 Python SDK を使ってコンピューティング クラスターを作成してから、それを使用してスクリプトをジョブとして実行します。

1. **Labs/04/Work with compute.ipynb** ノートブックを開きます。

    > **[認証]** を選択し、認証を求める通知が表示されたら、必要な手順に従います。 

1. ノートブックで **Python 3.8 - AzureML** カーネルが使用されていることを確認します。 
1. ノートブック内のすべてのセルを実行します。

## Azure リソースを削除する

Azure Machine Learning を調べ終わったら、不要な Azure のコストを避けるために作成したリソースを削除する必要があります。

1. [Azure Machine Learning スタジオ] タブを閉じて、Azure portal に戻ります。
1. Azure portal の **[ホーム]** ページで、**[リソース グループ]** を選択します。
1. **rg-dp100-labs** リソース グループを選択します。
1. リソース グループの **[概要]** ページの上部で、**[リソース グループの削除]** を選択します。 
1. リソース グループ名を入力して、削除することを確認し、**[削除]** を選択します。
